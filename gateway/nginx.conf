# events {} is required by nginx
events {}

http {
  client_max_body_size 10m;
  sendfile on;

  # -------- upstreams inside Docker network --------
  upstream usersvc_upstream   { server usersvc:5000; }
  # upstream eventsvc_upstream  { server eventsvc:6000; }
  
upstream eventsvc_upstream { server eventsvc:6000; }

  upstream bookingsvc_upstream { server bookingsvc:7000; }   # <-- NEW

  # allow only the local dev front-end. Add more origins if needed.
  map $http_origin $cors_allow_origin {
    default "";
    "~^http://localhost:5173$"    $http_origin;
    "~^http://127\.0\.0\.1:5173$" $http_origin;
  }

  server {
    listen 80;

    # simple gateway health
    location = /health {
      add_header Content-Type text/plain;
      return 200 "gateway ok\n";
    }

    # ======================================================
    # USERS
    # ======================================================
    location /users/ {
      # CORS for actual requests
      add_header Access-Control-Allow-Origin      $cors_allow_origin always;
      add_header Access-Control-Allow-Credentials "true"             always;

      # CORS for preflight
      if ($request_method = OPTIONS) {
        add_header Access-Control-Allow-Origin      $cors_allow_origin always;
        add_header Access-Control-Allow-Credentials "true"             always;
        add_header Access-Control-Allow-Methods     "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers     "Authorization, Content-Type, X-Requested-With" always;
        add_header Access-Control-Max-Age           86400              always;
        add_header Content-Length                   0;
        add_header Content-Type                     text/plain;
        return 204;
      }

      # proxy headers
      proxy_set_header Authorization      $http_authorization;
      proxy_set_header Host               $host;
      proxy_set_header X-Real-IP          $remote_addr;
      proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto  $scheme;

      proxy_pass http://usersvc_upstream/;
    }
        # ======================================================
    # EVENT POSTER IMAGES (serve static poster files)
    # ======================================================
    location /events/static/ {
        add_header Access-Control-Allow-Origin      $cors_allow_origin always;
        add_header Access-Control-Allow-Credentials "true" always;

        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # /events/static/...  ->  /static/... inside eventsvc
        proxy_pass http://eventsvc_upstream/static/;
    }

    # ======================================================
    # EVENT IMAGE UPLOAD  (POST /events/upload-image)
    # ======================================================
    location /events/upload-image {
        add_header Access-Control-Allow-Origin      $cors_allow_origin always;
        add_header Access-Control-Allow-Credentials "true" always;

        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin      $cors_allow_origin always;
            add_header Access-Control-Allow-Credentials "true" always;
            add_header Access-Control-Allow-Methods     "POST, OPTIONS";
            add_header Access-Control-Allow-Headers     "Authorization, Content-Type";
            add_header Content-Length                   0;
            add_header Content-Type                     text/plain;
            return 204;
        }

        proxy_set_header Host               $host;
        proxy_set_header X-Real-IP          $remote_addr;
        proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto  $scheme;

        # frontend:  /events/upload-image
        # backend:   /upload-image  (Flask)
        proxy_pass http://eventsvc_upstream/upload-image;
    }

    # ======================================================
    # EVENTS API  (/events/events, /events/events/<id>, etc)
    # ======================================================
    location /events/ {
        add_header Access-Control-Allow-Origin      $cors_allow_origin always;
        add_header Access-Control-Allow-Credentials "true" always;

        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin      $cors_allow_origin always;
            add_header Access-Control-Allow-Credentials "true" always;
            add_header Access-Control-Allow-Methods     "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers     "Authorization, Content-Type, X-Requested-With" always;
            add_header Access-Control-Max-Age           86400 always;
            add_header Content-Length                   0;
            add_header Content-Type                     text/plain;
            return 204;
        }

        proxy_set_header Authorization      $http_authorization;
        proxy_set_header Host               $host;
        proxy_set_header X-Real-IP          $remote_addr;
        proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto  $scheme;

        proxy_pass http://eventsvc_upstream/;
    }

      # ======================================================
  #     # EVENT IMAGE UPLOAD

  # location /events/static/ {
  #       add_header Access-Control-Allow-Origin      $cors_allow_origin always;
  #       add_header Access-Control-Allow-Credentials "true" always;

  #       proxy_set_header Host              $host;
  #       proxy_set_header X-Real-IP         $remote_addr;
  #       proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
  #       proxy_set_header X-Forwarded-Proto $scheme;

  #       # This forwards: /events/static/...  ->  /static/... inside eventsvc
  #       proxy_pass http://eventsvc_upstream/static/;
  #   }      # ======================================================
  #     # location /events/upload-image {
  #     #     add_header Access-Control-Allow-Origin      $cors_allow_origin always;
  #     #     add_header Access-Control-Allow-Credentials "true" always;

  #     #     if ($request_method = OPTIONS) {
  #     #         add_header Access-Control-Allow-Origin      $cors_allow_origin always;
  #     #         add_header Access-Control-Allow-Credentials "true" always;
  #     #         add_header Access-Control-Allow-Methods     "POST, OPTIONS";
  #     #         add_header Access-Control-Allow-Headers     "Authorization, Content-Type";
  #     #         add_header Content-Length                   0;
  #     #         add_header Content-Type                     text/plain;
  #     #         return 204;
  #     #     }

  #     #     proxy_set_header Host               $host;
  #     #     proxy_set_header X-Real-IP          $remote_addr;
  #     #     proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
  #     #     proxy_set_header X-Forwarded-Proto  $scheme;

  #     #     # ðŸ”¥ send to /upload-image INSIDE eventsvc
  #     #     proxy_pass http://eventsvc_upstream/upload-image;
  #     # }
  #   # ======================================================
  #     # EVENTS
  #     # ======================================================
  #     location /events/ {
  #       # CORS for actual requests
  #       add_header Access-Control-Allow-Origin      $cors_allow_origin always;
  #       add_header Access-Control-Allow-Credentials "true"             always;

  #       # CORS for preflight
  #       if ($request_method = OPTIONS) {
  #         add_header Access-Control-Allow-Origin      $cors_allow_origin always;
  #         add_header Access-Control-Allow-Credentials "true"             always;
  #         add_header Access-Control-Allow-Methods     "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
  #         add_header Access-Control-Allow-Headers     "Authorization, Content-Type, X-Requested-With" always;
  #         add_header Access-Control-Max-Age           86400              always;
  #         add_header Content-Length                   0;
  #         add_header Content-Type                     text/plain;
  #         return 204;
  #       }

  #       # proxy headers
  #       proxy_set_header Authorization      $http_authorization;
  #       proxy_set_header Host               $host;
  #       proxy_set_header X-Real-IP          $remote_addr;
  #       proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
  #       proxy_set_header X-Forwarded-Proto  $scheme;

  #       proxy_pass http://eventsvc_upstream/;
  #     }

    # ======================================================
    # BOOKINGS   (lock + confirm go here)
    # ======================================================
    location /bookings/ {
      # CORS for actual requests
      add_header Access-Control-Allow-Origin      $cors_allow_origin always;
      add_header Access-Control-Allow-Credentials "true"             always;

      # CORS for preflight
      if ($request_method = OPTIONS) {
        add_header Access-Control-Allow-Origin      $cors_allow_origin always;
        add_header Access-Control-Allow-Credentials "true"             always;
        add_header Access-Control-Allow-Methods     "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers     "Authorization, Content-Type, X-Requested-With" always;
        add_header Access-Control-Max-Age           86400              always;
        add_header Content-Length                   0;
        add_header Content-Type                     text/plain;
        return 204;
      }

      # proxy headers (need Authorization for JWT!)
      proxy_set_header Authorization      $http_authorization;
      proxy_set_header Host               $host;
      proxy_set_header X-Real-IP          $remote_addr;
      proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto  $scheme;

      proxy_pass http://bookingsvc_upstream/;
    }
  }
}
# # events {}
# events {}

# http {
#   client_max_body_size 10m;
#   sendfile on;

#   upstream usersvc_upstream { server usersvc:5000; }
#   upstream eventsvc_upstream { server eventsvc:6000; }

#   # allow only the local dev front-end. Add more origins if needed.
#   map $http_origin $cors_allow_origin {
#     default "";
#     "~^http://localhost:5173$"   $http_origin;
#     "~^http://127\.0\.0\.1:5173$" $http_origin;
#   }

#   server {
#     listen 80;

#     # simple health
#     location = /health {
#       add_header Content-Type text/plain;
#       return 200 "gateway ok\n";
#     }

#     # -------- USERS --------
#     location /users/ {
#       # CORS for actual requests
#       add_header Access-Control-Allow-Origin $cors_allow_origin always;
#       add_header Access-Control-Allow-Credentials "true" always;

#       # CORS for preflight
#       if ($request_method = OPTIONS) {
#         add_header Access-Control-Allow-Origin $cors_allow_origin always;
#         add_header Access-Control-Allow-Credentials "true" always;
#         add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
#         add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With" always;
#         add_header Access-Control-Max-Age 86400 always;
#         add_header Content-Length 0;
#         add_header Content-Type text/plain;
#         return 204;
#       }

#       # proxy headers
#       proxy_set_header Authorization $http_authorization;
#       proxy_set_header Host $host;
#       proxy_set_header X-Real-IP $remote_addr;
#       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#       proxy_set_header X-Forwarded-Proto $scheme;

#       proxy_pass http://usersvc_upstream/;
#     }

#     # -------- EVENTS --------
#     location /events/ {
#       # CORS for actual requests
#       add_header Access-Control-Allow-Origin $cors_allow_origin always;
#       add_header Access-Control-Allow-Credentials "true" always;

#       # CORS for preflight
#       if ($request_method = OPTIONS) {
#         add_header Access-Control-Allow-Origin $cors_allow_origin always;
#         add_header Access-Control-Allow-Credentials "true" always;
#         add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
#         add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With" always;
#         add_header Access-Control-Max-Age 86400 always;
#         add_header Content-Length 0;
#         add_header Content-Type text/plain;
#         return 204;
#       }

#       # proxy headers
#       proxy_set_header Authorization $http_authorization;
#       proxy_set_header Host $host;
#       proxy_set_header X-Real-IP $remote_addr;
#       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#       proxy_set_header X-Forwarded-Proto $scheme;

#       proxy_pass http://eventsvc_upstream/;
#     }
#   }
# }

# # http {
# #   # helpful defaults
# #   client_max_body_size 10m;
# #   sendfile on;

# #   # ------------ upstreams (targets inside Docker network) ------------
# #   upstream usersvc_upstream {
# #     server usersvc:5000;   # container name:port
# #   }

# #   upstream eventsvc_upstream {
# #     server eventsvc:6000;
# #   }

# #   upstream bookingsvc_upstream {
# #     server bookingsvc:7000;
# #   }

# #   # ------------ main gateway server ------------
# #   server {
# #     listen 80;

# #     # simple gateway health
# #     location = /health {
# #       add_header Content-Type text/plain;
# #       return 200 "gateway ok\n";
# #     }

# #     # forward headers (for JWT + logs)
# #     proxy_set_header Authorization     $http_authorization;
# #     proxy_set_header Host              $host;
# #     proxy_set_header X-Real-IP         $remote_addr;
# #     proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
# #     proxy_set_header X-Forwarded-Proto $scheme;

# #     # USERS: /users/... -> usersvc:5000/...
# #     location /users/ {
# #       proxy_pass http://usersvc_upstream/;   # âœ… fixed name
# #       proxy_redirect off;
# #     }

#     # EVENTS: /events/... -> eventsvc:6000/...
#     location /events/ {
#       proxy_pass http://eventsvc_upstream/;
#       proxy_redirect off;
#     }

# #     # BOOKINGS: /bookings/... -> bookingsvc:7000/...
# #     location /bookings/ {
# #       proxy_pass http://bookingsvc_upstream/;
# #       proxy_redirect off;
# #     }
# #   }
# # }

